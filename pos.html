<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halaman POS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="container mt-4">
        <h2>Halaman POS</h2>

        <!-- Pilih Pelanggan -->
        <div class="mt-4">
            <label for="customerRole" class="form-label">Pilih Role Pelanggan</label>
            <select id="customerRole" class="form-select" onchange="handleCustomerRole()">
                <option value="" disabled selected>Pilih Role</option>
                <option value="umum">Umum</option>
                <option value="pelsem">PelSem</option>
                <option value="pelmem">PelMem</option>
            </select>
        </div>

        <div id="customerDetails" class="mt-3">
            <!-- Form pelanggan akan dimuat di sini -->
        </div>

        <!-- Pilih Produk -->
        <div class="mt-4">
            <label for="productSelect" class="form-label">Pilih Produk</label>
            <select id="productSelect" class="form-select">
                <!-- Produk akan dimuat dari localStorage -->
            </select>
        </div>
        <button class="btn btn-primary mt-2" onclick="addToCart()">Tambah ke Keranjang</button>

        <!-- Keranjang -->
        <div class="mt-4">
            <h5>Keranjang</h5>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Nama Produk</th>
                        <th>Harga</th>
                        <th>Jumlah</th>
                        <th>Subtotal</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="cartTableBody"></tbody>
            </table>
        </div>

        <!-- Total & Diskon -->
        <div class="mt-4">
            <div class="row">
                <div class="col-md-6">
                    <label for="discount" class="form-label">Diskon (%)</label>
                    <input type="number" id="discount" class="form-control" value="0" oninput="updateTotal()">
                </div>
                <div class="col-md-6">
                    <h5>Total: <span id="totalAmount">0</span> IDR</h5>
                </div>
            </div>
        </div>

        <!-- Metode Pembayaran -->
        <div class="mt-4">
            <label for="paymentMethod" class="form-label">Metode Pembayaran</label>
            <select id="paymentMethod" class="form-select" onchange="handlePaymentMethod()">
                <option value="" disabled selected>Pilih Metode</option>
                <option value="cash">Cash</option>
                <option value="transfer">Transfer</option>
                <option value="ewallet">E-Wallet</option>
            </select>
        </div>

        <div id="paymentDetails" class="mt-3">
            <!-- Form pembayaran akan dimuat di sini -->
        </div>

        <button class="btn btn-success mt-4" onclick="finalizePayment()">Proses Pembayaran</button>
    </div>

    <script>
        let cart = [];
        let totalAmount = 0;

        function handleCustomerRole() {
            const role = document.getElementById("customerRole").value;
            const detailsContainer = document.getElementById("customerDetails");

            if (role === "umum") {
                detailsContainer.innerHTML = `
                    <label for="customerName" class="form-label">Nama Pelanggan</label>
                    <input type="text" id="customerName" class="form-control">
                    <label for="customerContact" class="form-label">Kontak</label>
                    <input type="text" id="customerContact" class="form-control">
                    <label for="customerEmail" class="form-label">Email</label>
                    <input type="email" id="customerEmail" class="form-control">
                    <label for="customerAddress" class="form-label">Alamat</label>
                    <textarea id="customerAddress" class="form-control"></textarea>
                `;
            } else {
                // Load customer data automatically
                const customers = JSON.parse(localStorage.getItem("customers")) || [];
                const customer = customers.find(c => c.role === role);
                if (customer) {
                    detailsContainer.innerHTML = `
                        <p><strong>Nama:</strong> ${customer.name}</p>
                        <p><strong>Kontak:</strong> ${customer.contact}</p>
                        <p><strong>Email:</strong> ${customer.email}</p>
                        <p><strong>Alamat:</strong> ${customer.address}</p>
                    `;
                }
            }
        }

        function addToCart() {
            const productSelect = document.getElementById("productSelect");
            const productName = productSelect.options[productSelect.selectedIndex].text;
            const productPrice = parseInt(productSelect.value);

            cart.push({ name: productName, price: productPrice, quantity: 1, subtotal: productPrice });
            updateCart();
        }

        function updateCart() {
            const tableBody = document.getElementById("cartTableBody");
            tableBody.innerHTML = "";

            cart.forEach((item, index) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td>${item.price}</td>
                    <td>
                        <input type="number" value="${item.quantity}" min="1" class="form-control" onchange="updateQuantity(${index}, this.value)">
                    </td>
                    <td>${item.subtotal}</td>
                    <td><button class="btn btn-danger btn-sm" onclick="removeFromCart(${index})">Hapus</button></td>
                `;
                tableBody.appendChild(row);
            });

            updateTotal();
        }

        function updateQuantity(index, quantity) {
            cart[index].quantity = parseInt(quantity);
            cart[index].subtotal = cart[index].price * cart[index].quantity;
            updateCart();
        }

        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCart();
        }

        function updateTotal() {
            totalAmount = cart.reduce((sum, item) => sum + item.subtotal, 0);
            const discount = parseInt(document.getElementById("discount").value) || 0;
            totalAmount -= (totalAmount * discount) / 100;
            document.getElementById("totalAmount").innerText = totalAmount;
        }

        function handlePaymentMethod() {
            const method = document.getElementById("paymentMethod").value;
            const detailsContainer = document.getElementById("paymentDetails");

            if (method === "cash") {
                detailsContainer.innerHTML = `
                    <label for="cashReceived" class="form-label">Jumlah Uang Diterima</label>
                    <input type="number" id="cashReceived" class="form-control" oninput="calculateChange()">
                    <p>Kembalian: <span id="changeAmount">0</span> IDR</p>
                `;
            } else {
                detailsContainer.innerHTML = `
                    <label for="paymentProof" class="form-label">Upload Bukti Pembayaran</label>
                    <input type="file" id="paymentProof" class="form-control">
                `;
            }
        }

        function calculateChange() {
            const cashReceived = parseInt(document.getElementById("cashReceived").value) || 0;
            const change = cashReceived - totalAmount;
            document.getElementById("changeAmount").innerText = change >= 0 ? change : 0;
        }

        function finalizePayment() {
            const method = document.getElementById("paymentMethod").value;

            if (method === "cash") {
                const cashReceived = parseInt(document.getElementById("cashReceived").value) || 0;

                if (cashReceived >= totalAmount) {
                    Swal.fire("Pembayaran Berhasil", "Status: Lunas", "success");
                } else {
                    Swal.fire("Pembayaran Gagal", "Jumlah uang kurang", "error");
                }
            } else {
                const paymentProof = document.getElementById("paymentProof").files[0];
                if (paymentProof) {
                    Swal.fire("Pembayaran Berhasil", "Bukti pembayaran telah diunggah", "success");
                } else {
                    Swal.fire("Pembayaran Gagal", "Silakan unggah bukti pembayaran", "error");
                }
            }
        }
    </script>
</body>
</html>
