<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS dengan Total dan Kembalian</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div class="container mt-4">
        <h2>Sistem POS</h2>
        <hr>

        <!-- Form Transaksi -->
        <div class="mt-4">
            <h4>Form Transaksi</h4>
            <form id="posForm">
                <!-- ID Transaksi -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="transactionId" class="form-label">ID Transaksi</label>
                        <input type="text" id="transactionId" class="form-control" readonly>
                    </div>
                </div>

                <!-- Pilih Pelanggan -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="customerRole" class="form-label">Role Pelanggan</label>
                        <select id="customerRole" class="form-select">
                            <option value="">Pilih Role</option>
                            <option value="umum">Umum</option>
                            <option value="pelsem">PelSem</option>
                            <option value="pelmem">PelMem</option>
                        </select>
                    </div>
                </div>
                <div id="customerDetails" class="row mb-3">
                    <!-- Detail pelanggan akan dimuat otomatis atau manual -->
                </div>

                <!-- Pilih Produk -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="product" class="form-label">Pilih Produk</label>
                        <select id="product" class="form-select">
                            <!-- Produk dimuat dari localStorage -->
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="productQuantity" class="form-label">Jumlah</label>
                        <input type="number" id="productQuantity" class="form-control" min="1" value="1">
                    </div>
                </div>

                <!-- Diskon -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="discountType" class="form-label">Diskon</label>
                        <select id="discountType" class="form-select">
                            <option value="none">Tanpa Diskon</option>
                            <option value="percent">Persen (%)</option>
                            <option value="rupiah">Rupiah</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="discountValue" class="form-label">Nilai Diskon</label>
                        <input type="number" id="discountValue" class="form-control" value="0" min="0">
                    </div>
                </div>

                <!-- Tambah ke Keranjang -->
                <button type="button" id="addToCartButton" class="btn btn-primary">Tambah ke Keranjang</button>
            </form>
        </div>

        <!-- Keranjang -->
        <div class="mt-5">
            <h4>Keranjang</h4>
            <table class="table table-bordered">
                <thead class="table-primary">
                    <tr>
                        <th>No</th>
                        <th>Nama Produk</th>
                        <th>Harga</th>
                        <th>Jumlah</th>
                        <th>Diskon</th>
                        <th>Total</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="cartTableBody">
                    <!-- Keranjang akan dimuat di sini -->
                </tbody>
            </table>
            <div class="text-end">
                <h5>Total Pembayaran: <span id="totalPayment">Rp 0</span></h5>
            </div>
        </div>

        <!-- Pembayaran -->
        <div class="mt-5">
            <h4>Pembayaran</h4>
            <form id="paymentForm">
                <!-- Metode Pembayaran -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="paymentMethod" class="form-label">Metode Pembayaran</label>
                        <select id="paymentMethod" class="form-select">
                            <option value="cash">Cash</option>
                            <option value="non-cash">Non-Cash</option>
                        </select>
                    </div>
                </div>

                <div class="row mb-3" id="paymentDetails">
                    <div class="col-md-6">
                        <label for="paymentAmount" class="form-label">Jumlah Uang</label>
                        <input type="number" id="paymentAmount" class="form-control" min="0">
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="changeAmount" class="form-label">Kembalian</label>
                        <input type="text" id="changeAmount" class="form-control" readonly>
                    </div>
                </div>
                <button type="button" id="processPaymentButton" class="btn btn-success">Proses Pembayaran</button>
            </form>
        </div>
    </div>

    <script>
        let cart = [];

        // ID Transaksi unik otomatis
        function generateTransactionId() {
            return `TRX-${Date.now()}`;
        }

        // Muat produk dari localStorage
        function loadProducts() {
            const products = JSON.parse(localStorage.getItem("products")) || [];
            const productSelect = document.getElementById("product");
            productSelect.innerHTML = '<option value="">Pilih Produk</option>';
            products.forEach(product => {
                const option = document.createElement("option");
                option.value = product.id;
                option.textContent = `${product.name} - Rp ${product.price}`;
                productSelect.appendChild(option);
            });
        }

        // Tambahkan produk ke keranjang
        function addToCart() {
            const productSelect = document.getElementById("product");
            const quantity = parseInt(document.getElementById("productQuantity").value, 10);
            const discountType = document.getElementById("discountType").value;
            const discountValue = parseInt(document.getElementById("discountValue").value, 10) || 0;

            if (!productSelect.value || quantity <= 0) {
                Swal.fire("Error", "Pilih produk dan masukkan jumlah yang valid!", "error");
                return;
            }

            const products = JSON.parse(localStorage.getItem("products")) || [];
            const product = products.find(prod => prod.id === productSelect.value);

            let discount = 0;
            if (discountType === "percent") {
                discount = (product.price * discountValue / 100) * quantity;
            } else if (discountType === "rupiah") {
                discount = discountValue * quantity;
            }

            const total = (product.price * quantity) - discount;

            cart.push({
                name: product.name,
                price: product.price,
                quantity: quantity,
                discount: discount,
                total: total,
            });

            updateCartTable();
        }

        // Perbarui tabel keranjang
        function updateCartTable() {
            const cartTableBody = document.getElementById("cartTableBody");
            cartTableBody.innerHTML = "";

            let totalPayment = 0;
            cart.forEach((item, index) => {
                totalPayment += item.total;

                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.name}</td>
                    <td>Rp ${item.price}</td>
                    <td>${item.quantity}</td>
                    <td>Rp ${item.discount}</td>
                    <td>Rp ${item.total}</td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="removeFromCart(${index})">Hapus</button>
                    </td>
                `;
                cartTableBody.appendChild(row);
            });

            document.getElementById("totalPayment").textContent = `Rp ${totalPayment}`;
        }

        // Hapus item dari keranjang
        function removeFromCart(index) {
            cart.splice(index, 1);
            updateCartTable();
        }

        // Proses pembayaran
        function processPayment() {
            const totalPayment = cart.reduce((sum, item) => sum + item.total, 0);
            const paymentMethod = document.getElementById("paymentMethod").value;
            const paymentAmount = parseInt(document.getElementById("paymentAmount").value, 10);

            if (paymentMethod === "cash") {
                if (paymentAmount < totalPayment) {
                    Swal.fire("Error", "Jumlah uang kurang dari total pembayaran!", "error");
                    return;
                }

                const change = paymentAmount - totalPayment;
                document.getElementById("changeAmount").value = `Rp ${change}`;
                Swal.fire("Sukses", "Pembayaran berhasil dengan uang tunai!", "success");

            } else if (paymentMethod === "non-cash") {
                Swal.fire("Sukses", "Pembayaran non-cash akan diproses lebih lanjut!", "info");
            }
        }

        // Inisialisasi
        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("transactionId").value = generateTransactionId();
            loadProducts();

            document.getElementById("addToCartButton").addEventListener("click", addToCart);
            document.getElementById("processPaymentButton").addEventListener("click", processPayment);
        });
    </script>
</body>
</html>
