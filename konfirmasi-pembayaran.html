<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Konfirmasi Pembayaran</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div class="container mt-4">
        <h2>Konfirmasi Pembayaran</h2>

        <!-- Filter dan Pencarian -->
        <div class="d-flex justify-content-between mt-4">
            <div>
                <select id="statusFilter" class="form-select" onchange="filterPayments()">
                    <option value="all">Semua Status</option>
                    <option value="lunas">Lunas</option>
                    <option value="menunggu">Menunggu Pembayaran</option>
                </select>
            </div>
            <div>
                <input type="text" id="searchInput" class="form-control" placeholder="Cari ID transaksi atau nama pelanggan..." oninput="filterPayments()">
            </div>
        </div>

        <!-- Tabel Daftar Pembayaran -->
        <div class="mt-4">
            <table class="table table-bordered">
                <thead class="table-primary">
                    <tr>
                        <th>ID Transaksi</th>
                        <th>Nama Pelanggan</th>
                        <th>Total (Diskon)</th>
                        <th>Metode Pembayaran</th>
                        <th>Status</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="paymentTableBody">
                    <!-- Data pembayaran akan dimuat di sini -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let payments = JSON.parse(localStorage.getItem("transactions")) || [];
        let customers = JSON.parse(localStorage.getItem("customers")) || [];

        // Mendapatkan diskon pelanggan
        function getCustomerDiscount(customerId) {
            const customer = customers.find(cust => cust.id === customerId);
            return customer ? customer.discount : 0;
        }

        // Menampilkan daftar pembayaran ke tabel
        function loadPayments() {
            const paymentTableBody = document.getElementById("paymentTableBody");
            paymentTableBody.innerHTML = "";

            payments.forEach((payment, index) => {
                const discount = getCustomerDiscount(payment.customerId);
                const discountedTotal = payment.total - (payment.total * discount / 100);

                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${payment.id}</td>
                    <td>${payment.customerName || "N/A"}</td>
                    <td>${discountedTotal.toFixed(2)} IDR (${discount}% diskon)</td>
                    <td>${payment.paymentMethod}</td>
                    <td>
                        <span class="badge ${payment.transactionStatus === "lunas" ? "bg-success" : "bg-warning"}">
                            ${payment.transactionStatus === "lunas" ? "Lunas" : "Menunggu Pembayaran"}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewDetails(${index})">Detail</button>
                        ${
                            payment.transactionStatus === "menunggu"
                                ? `<button class="btn btn-sm btn-success ms-2" onclick="confirmPayment(${index})">Konfirmasi</button>`
                                : "-"
                        }
                    </td>
                `;
                paymentTableBody.appendChild(row);
            });
        }

        // Filter pembayaran berdasarkan status dan pencarian
        function filterPayments() {
            const statusFilter = document.getElementById("statusFilter").value;
            const query = document.getElementById("searchInput").value.toLowerCase();

            const filteredPayments = payments.filter(payment => {
                const matchesStatus =
                    statusFilter === "all" ||
                    payment.transactionStatus === statusFilter;
                const matchesQuery =
                    payment.id.toLowerCase().includes(query) ||
                    (payment.customerName && payment.customerName.toLowerCase().includes(query));
                return matchesStatus && matchesQuery;
            });

            const paymentTableBody = document.getElementById("paymentTableBody");
            paymentTableBody.innerHTML = "";

            filteredPayments.forEach((payment, index) => {
                const discount = getCustomerDiscount(payment.customerId);
                const discountedTotal = payment.total - (payment.total * discount / 100);

                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${payment.id}</td>
                    <td>${payment.customerName || "N/A"}</td>
                    <td>${discountedTotal.toFixed(2)} IDR (${discount}% diskon)</td>
                    <td>${payment.paymentMethod}</td>
                    <td>
                        <span class="badge ${payment.transactionStatus === "lunas" ? "bg-success" : "bg-warning"}">
                            ${payment.transactionStatus === "lunas" ? "Lunas" : "Menunggu Pembayaran"}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewDetails(${index})">Detail</button>
                        ${
                            payment.transactionStatus === "menunggu"
                                ? `<button class="btn btn-sm btn-success ms-2" onclick="confirmPayment(${index})">Konfirmasi</button>`
                                : "-"
                        }
                    </td>
                `;
                paymentTableBody.appendChild(row);
            });
        }

        // Konfirmasi pembayaran
        function confirmPayment(index) {
            Swal.fire({
                title: "Konfirmasi Pembayaran",
                text: "Apakah Anda yakin ingin mengkonfirmasi pembayaran ini?",
                icon: "warning",
                showCancelButton: true,
                confirmButtonText: "Ya, Konfirmasi",
                cancelButtonText: "Batal"
            }).then(result => {
                if (result.isConfirmed) {
                    payments[index].transactionStatus = "lunas";
                    localStorage.setItem("transactions", JSON.stringify(payments));
                    Swal.fire("Sukses", "Pembayaran telah dikonfirmasi!", "success").then(() => loadPayments());
                }
            });
        }

        // Menampilkan detail pembayaran
        function viewDetails(index) {
            const payment = payments[index];
            Swal.fire({
                title: "Detail Pembayaran",
                html: `
                    <p><strong>ID Transaksi:</strong> ${payment.id}</p>
                    <p><strong>Nama Pelanggan:</strong> ${payment.customerName || "N/A"}</p>
                    <p><strong>Total Pembayaran:</strong> ${payment.total} IDR</p>
                    <p><strong>Metode Pembayaran:</strong> ${payment.paymentMethod}</p>
                    <p><strong>Status:</strong> ${
                        payment.transactionStatus === "lunas" ? "Lunas" : "Menunggu Pembayaran"
                    }</p>
                `,
                icon: "info",
            });
        }

        // Inisialisasi
        document.addEventListener("DOMContentLoaded", () => {
            loadPayments();
        });
    </script>
</body>
</html>
